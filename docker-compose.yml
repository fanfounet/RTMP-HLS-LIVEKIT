
version: "3.8"

services:
  # ---- Message bus ---------------------------------------------------------
  redis:
    image: redis:7-alpine
    container_name: redis
    restart: unless-stopped

  # ---- LiveKit server ------------------------------------------------------
  livekit:
    image: livekit/livekit-server:latest
    container_name: livekit
    command: >
      --dev
      --bind 0.0.0.0
      --node-ip 127.0.0.1
      --redis-host redis:6379
      --config /config/livekit.yaml
    volumes:
      - ./livekit.yaml:/config/livekit.yaml:ro
    ports:
      - "7880:7880"       # HTTP/WebSocket (signaling + API)
    depends_on:
      - redis
    restart: unless-stopped

  # ---- Ingress (RTMP/WHIP → LiveKit) --------------------------------------
  ingress:
    image: livekit/ingress:latest
    container_name: livekit-ingress
    command: --config /config/ingress.yaml
    volumes:
      - ./ingress.yaml:/config/ingress.yaml:ro
    ports:
      - "1935:1935"  # RTMP in
      - "8083:8083"  # WHIP (optionnel)
    depends_on:
      - redis
      - livekit
    restart: unless-stopped

# ---- Egress (LiveKit → RTMP/HLS) ---------------------------------------
  egress:
    image: livekit/egress:latest
    container_name: livekit-egress
    cap_add:
      - SYS_ADMIN

    environment:
      EGRESS_CONFIG_FILE: /config/egress.yaml

    volumes:
      - ./egress.yaml:/config/egress.yaml:ro
      - ./hls:/output
    depends_on:
      - redis
      - livekit
    restart: unless-stopped
  
# --- HLS Server ---------------------------------------------------------
  hls-server:
    image: httpd:alpine
    container_name: hls-server
    ports:
      - "8000:80"
    volumes:
      - ./hls:/usr/local/apache2/htdocs/:ro
      - ./hls.conf:/usr/local/apache2/conf/extra/hls.conf:ro
    command: ["/bin/sh","-c","echo 'Include conf/extra/hls.conf' >> /usr/local/apache2/conf/httpd.conf && httpd-foreground"]
    depends_on:
      - egress
    restart: unless-stopped

# ---- LiveKit Web UI ------------------------------------------------------
  ui:
    build: ./ui
    container_name: livekit-ui
    ports:
      - "5000:5000"
    depends_on:
      - livekit
      - ingress
      - egress
    restart: unless-stopped


# ---- HLS Cleanup Service -------------------------------------------------
  cleaner:
    image: alpine
    volumes:
      - ./hls:/hls
    entrypoint: ["sh", "-c", "while true; do find /hls -type f -name '*.ts' -mmin +5 -delete; sleep 60; done"]


